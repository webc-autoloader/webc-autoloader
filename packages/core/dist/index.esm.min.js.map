{"version":3,"file":"index.esm.min.js","sources":["../src/importmap.ts","../src/webc.ts","../src/config.ts","../src/autoload.ts","../src/handler.ts"],"sourcesContent":["import { IImportMap, IKeyInfo, ILoadMap, IPrefixMap } from \"./types.js\";\r\n\r\nconst COMPONENT_KEYWORD = \"@components/\";\r\n\r\nexport function loadImportmap(): IImportMap | null {\r\n  const importmap: IImportMap = { imports: {} };\r\n  document.querySelectorAll('script[type=\"importmap\"]').forEach((script) => {\r\n    try {\r\n      const json = JSON.parse(script.innerHTML);\r\n      if (json.imports) {\r\n        importmap.imports = Object.assign(importmap.imports, json.imports);\r\n      }\r\n    } catch (e) {\r\n      throw new Error(\"Failed to parse importmap JSON: \" + e);\r\n    }\r\n  });\r\n  return Object.keys(importmap.imports).length > 0\r\n    ? importmap\r\n    : null;\r\n}\r\n\r\nfunction getKeyInfoFromImportmapKey(key: string): IKeyInfo | null {\r\n  if (key.startsWith(COMPONENT_KEYWORD)) {\r\n    if (key.endsWith(\"/\")) {\r\n      const prefixWithLoader = key.slice(COMPONENT_KEYWORD.length, key.length - 1);\r\n      const [ prefix, loaderKey ] = prefixWithLoader.split(\"|\", 2);\r\n      if (prefix === \"\") {\r\n        throw new Error(\"Invalid importmap key: \" + key);\r\n      }\r\n      return {\r\n        key,\r\n        prefix: prefix.replaceAll(\"/\", \"-\").toLowerCase(),\r\n        loaderKey: loaderKey ?? null,\r\n        isNameSpaced: true\r\n      };\r\n    } else {\r\n      const tagNamePart = key.slice(COMPONENT_KEYWORD.length);\r\n      const [ tagName, loaderKeyPart ] = tagNamePart.split(\"|\", 2);\r\n      const [ loaderKey, extendsText ] = (loaderKeyPart ?? \"\").split(\",\", 2);\r\n      if (tagName === \"\") {\r\n        throw new Error(\"Invalid importmap key: \" + key);\r\n      }\r\n      return {\r\n        key,\r\n        tagName: tagName.replaceAll(\"/\", \"-\").toLowerCase(),\r\n        loaderKey: loaderKey ?? null,\r\n        extends: extendsText ?? null,\r\n        isNameSpaced: false\r\n      };\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function buildMap(importmap: IImportMap): {\r\n  prefixMap: IPrefixMap, loadMap: ILoadMap\r\n} {\r\n  const prefixMap: IPrefixMap = {};\r\n  const loadMap: ILoadMap = {};\r\n  for (const [key, value] of Object.entries(importmap.imports)) {\r\n    const keyInfo = getKeyInfoFromImportmapKey(key);\r\n    if (keyInfo === null) {\r\n      continue;\r\n    }\r\n    if (keyInfo.isNameSpaced) {\r\n      prefixMap[keyInfo.prefix] = keyInfo;\r\n    } else {\r\n      loadMap[keyInfo.tagName] = keyInfo;\r\n    }\r\n  }\r\n  return { prefixMap, loadMap };\r\n}","\r\n\r\nexport async function load(path: string): Promise<CustomElementConstructor> {\r\n  const module = await import(path);\r\n  return module.default as CustomElementConstructor;\r\n}","\r\nimport { IConfig } from \"./types.js\"\r\nimport { load } from \"./webc.js\"\r\n\r\nexport const DEFAULT_KEY = \"*\";\r\n\r\nexport const WEBC_KEY = \"webc\";\r\n\r\nexport const WEBC_LOADER = {\r\n  postfix: \".webc.js\",\r\n  loader: load\r\n}\r\n\r\nexport const DEFAULT_CONFIG: IConfig = {\r\n  scanImportmap: true,\r\n  loaders: {\r\n    [WEBC_KEY]: WEBC_LOADER,\r\n    [DEFAULT_KEY]: WEBC_KEY\r\n  },\r\n  observable: true\r\n}\r\n","import { DEFAULT_KEY } from \"./config.js\";\r\nimport { IEagerLoadInfo, ILoader, INameSpaceInfo, IPrefixMap, ITagInfo } from \"./types.js\";\r\n\r\nconst failedTags = new Set<string>();\r\nconst loadingTags = new Set<string>();\r\n\r\nfunction getTagInfoFromElement(e: Element): ITagInfo {\r\n  let elementTagName = e.tagName.toLowerCase();\r\n  let name;\r\n  let extendsName;\r\n  if (elementTagName.includes(\"-\")) {\r\n    name = elementTagName;\r\n    extendsName = null;\r\n  } else {\r\n    const tagName = e.getAttribute(\"is\");\r\n    if (tagName === null) {\r\n      throw new Error(\"Custom element without a dash or 'is' attribute found: \" + elementTagName);\r\n    }\r\n    if (!tagName.includes(\"-\")) {\r\n      throw new Error(\"Custom element 'is' attribute without a dash found: \" + elementTagName);\r\n    }\r\n    name = tagName;\r\n    extendsName = elementTagName;\r\n  }\r\n  return { name, extends: extendsName };\r\n}\r\n\r\nfunction matchNameSpace(tagName: string, prefixMap: IPrefixMap): INameSpaceInfo | null {\r\n  for (const [prefix, info] of Object.entries(prefixMap)) {\r\n    if (tagName.startsWith(prefix + \"-\")) {\r\n      return info;\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nexport async function lazyLoad(\r\n  root: Document | ShadowRoot, \r\n  prefixMap: IPrefixMap,\r\n  loaders: Record<string, ILoader | string>\r\n): Promise<void> {\r\n  let elements = root.querySelectorAll(':not(:defined)');\r\n  const duplicateCheck = new Set<string>(); // UpperCase tag names\r\n  for(const element of elements) {\r\n    const tagName = element.tagName;\r\n    if (duplicateCheck.has(tagName)) {\r\n      continue;\r\n    }\r\n    duplicateCheck.add(tagName);\r\n    const { name, extends: extendsName } = getTagInfoFromElement(element);\r\n    if (failedTags.has(name)) {\r\n      continue;\r\n    }\r\n    if (loadingTags.has(name)) {\r\n      continue;\r\n    }\r\n    let info: INameSpaceInfo | null = matchNameSpace(name, prefixMap);\r\n    if (info === null) {\r\n      throw new Error(\"No matching namespace found for lazy loaded component: \" + name);\r\n    }\r\n    let loader: ILoader | string;\r\n    if (info.loaderKey === null || info.loaderKey === DEFAULT_KEY || info.loaderKey === \"\") {\r\n      loader = loaders[DEFAULT_KEY];\r\n      if (typeof loader === \"string\") {\r\n        loader = loaders[loader];\r\n      }\r\n    } else {\r\n      loader = loaders[info.loaderKey];\r\n    }\r\n    if (typeof loader === \"string\") {\r\n      throw new Error(\"Loader redirection is not supported for eager loaded components: \" + tagName);\r\n    }\r\n    loadingTags.add(name);\r\n\r\n    let file: string = name.slice(info.prefix.length + 1);\r\n    if (file === \"\") {\r\n      throw new Error(\"Invalid component name for lazy loaded component: \" + name);\r\n    }\r\n    const path = info.key + file + loader.postfix;\r\n    try {\r\n      const componentConstructor = await loader.loader(path);\r\n      if (componentConstructor !== null) {\r\n        if (extendsName === null) {\r\n          customElements.define(name, componentConstructor);\r\n        } else {\r\n          customElements.define(name, componentConstructor, { extends: extendsName });\r\n        }\r\n      }\r\n    } catch(e) {\r\n      if (!failedTags.has(name)) {\r\n        console.error(`Failed to lazy load component '${name}':`, e);\r\n        failedTags.add(name);\r\n      }\r\n    } finally {\r\n      loadingTags.delete(name);\r\n    }\r\n  }\r\n}\r\n\r\nexport async function eagerLoad(\r\n  loadMap: Record<string, IEagerLoadInfo>, \r\n  loaders: Record<string, ILoader | string>\r\n): Promise<void> {\r\n  for(const [tagName, info] of Object.entries(loadMap)) {\r\n    let loader: ILoader | string;\r\n    if (info.loaderKey === null || info.loaderKey === DEFAULT_KEY || info.loaderKey === \"\") {\r\n      loader = loaders[DEFAULT_KEY];\r\n      if (typeof loader === \"string\") {\r\n        loader = loaders[loader];\r\n      }\r\n    } else {\r\n      loader = loaders[info.loaderKey];\r\n    }\r\n    if (typeof loader === \"string\") {\r\n      throw new Error(\"Loader redirection is not supported for eager loaded components: \" + tagName);\r\n    }\r\n    try {\r\n      const componentConstructor = await loader.loader(info.key);\r\n      if (componentConstructor !== null) {\r\n        if (info.extends === null) {\r\n          customElements.define(tagName, componentConstructor);\r\n        } else {\r\n          customElements.define(tagName, componentConstructor, { extends: info.extends });\r\n        }\r\n      }\r\n    } catch(e) {\r\n      if (!failedTags.has(tagName)) {\r\n        console.error(`Failed to eager load component '${tagName}':`, e);\r\n        failedTags.add(tagName);\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { buildMap, loadImportmap } from \"./importmap.js\";\r\nimport { DEFAULT_CONFIG as config } from \"./config.js\";\r\nimport { eagerLoad, lazyLoad } from \"./autoload.js\";\r\n\r\nexport async function registerHandler(): Promise<void> {\r\n  const importmap = loadImportmap(); // 事前に importmap を読み込んでおく\r\n  if (importmap === null) {\r\n    return;\r\n  }\r\n  const { prefixMap, loadMap } = buildMap(importmap);\r\n  // 先にeager loadを実行すると、DOMContentLoadedイベントが発生しないことがあるため、後に実行する\r\n\r\n  document.addEventListener(\"DOMContentLoaded\", async (): Promise<void> => {\r\n    if (Object.keys(prefixMap).length === 0) {\r\n      return;\r\n    }\r\n    try {\r\n      await lazyLoad(document, prefixMap, config.loaders);\r\n    } catch(e) {\r\n      throw new Error(\"Failed to lazy load components: \" + e);\r\n    }\r\n\r\n    if (!config.observable) {\r\n      return;\r\n    }\r\n    const mo = new MutationObserver(async (): Promise<void> => {\r\n      try {\r\n        await lazyLoad(document, prefixMap, config.loaders);\r\n      } catch(e) {\r\n        throw new Error(\"Failed to lazy load components: \" + e);\r\n      }\r\n    });\r\n    mo.observe(document.documentElement, { childList: true, subtree: true });\r\n  });\r\n\r\n  try {\r\n    await eagerLoad(loadMap, config.loaders);\r\n  } catch(e) {\r\n    throw new Error(\"Failed to eager load components: \" + e);\r\n  }\r\n}\r\n\r\n"],"names":["COMPONENT_KEYWORD","loadImportmap","importmap","imports","document","querySelectorAll","forEach","script","json","JSON","parse","innerHTML","Object","assign","e","Error","keys","length","getKeyInfoFromImportmapKey","key","startsWith","endsWith","prefixWithLoader","slice","prefix","loaderKey","split","replaceAll","toLowerCase","isNameSpaced","tagNamePart","tagName","loaderKeyPart","extendsText","extends","buildMap","prefixMap","loadMap","value","entries","keyInfo","async","load","path","import","default","DEFAULT_KEY","WEBC_KEY","WEBC_LOADER","postfix","loader","DEFAULT_CONFIG","scanImportmap","loaders","observable","failedTags","Set","loadingTags","getTagInfoFromElement","name","extendsName","elementTagName","includes","getAttribute","matchNameSpace","info","lazyLoad","root","elements","duplicateCheck","element","has","add","file","componentConstructor","customElements","define","console","error","delete","eagerLoad","registerHandler","addEventListener","config","MutationObserver","observe","documentElement","childList","subtree"],"mappings":"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"}